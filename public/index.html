<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Bad Hanabi</title>
    <script defer src="/__/firebase/5.8.3/firebase-app.js"></script>
    <script defer src="/__/firebase/5.8.3/firebase-auth.js"></script>
    <script defer src="/__/firebase/5.8.3/firebase-firestore.js"></script>
    <script defer src="/__/firebase/init.js"></script>
    <script defer src="https://unpkg.com/mithril/mithril.js"></script>
    <script defer src="https://unpkg.com/lodash/lodash.js"></script>
    <script>
    const COLORS = ['R', 'G', 'B', 'Y', 'W', 'P'];
    function generateDeck() {
      let tiles = [];
      COLORS.forEach(c => {
        tiles.push(`${c}1`);
        tiles.push(`${c}1`);
        tiles.push(`${c}1`);
        tiles.push(`${c}2`);
        tiles.push(`${c}2`);
        tiles.push(`${c}3`);
        tiles.push(`${c}3`);
        tiles.push(`${c}4`);
        tiles.push(`${c}4`);
        tiles.push(`${c}5`);
      });
      _.shuffle(tiles);
      return tiles;
    }
    function handSize(numPlayers) {
      switch (numPlayers) {
        case 2: return 6;
        case 3: return 5;
        case 4: return 4;
        case 5: return 4;
        default: throw new Error("game only supports 2--5 players");
      }
    }
    function drawTiles(tiles, num_tiles) {
      let ts = [];
      for (let i=0; i < num_tiles; i++) {
        ts.push(tiles.pop());
      }
      return ts;
    }

    const ROOM_STATES = {
      WAITING_TO_START: "waiting to start",
    };
    </script>
    <script>
      document.addEventListener('DOMContentLoaded', function() {
        let state = {
          messages: [],
          uid: null,
          rooms: {},
          current_room: null,
          view: function() {
            return m("main", [
              m('div', {
                id: "messages",
              }, state.messages.map(msg => m('p', msg))),
              m('input', {
                id: "user_input",
                onchange: onUserInput,
                placeholder: "user_input goes here",
              }),
            ]);
          }
        };
        function log(msg) {
          state.messages.push(msg);
          return true;
        }

        const app = firebase.app();
        app.auth().onAuthStateChanged(evt => {
          state.uid = evt.uid;
        });
        app.firestore().collection("rooms").onSnapshot(snap => {
          console.log("rooms collection: ", snap);
          snap.forEach(doc => {
            state.rooms[doc.id] = doc.data();
            console.log(`rooms[${doc.id}] = ${JSON.stringify(doc.data())}`);
          });
        });

        function help() {
          if (!state.uid) {
            return log("you're not logged in yet, this should happen automatically");
          }
          if (!state.current_room) {
            return log("you're not in a room, try making one with /make or joining one with /join (/list to see which rooms exist)");
          }
          if (state.rooms[state.current_room].state != ROOM_STATES.WAITING_TO_START) {
            return log(`game '${state.current_room}' hasn't started yet, try /start`);
          }
          return log("[UNREACHABLE] this shit is busted, my bad");
        }
        function makeRoom(name) {
          app.firestore().collection("rooms").doc(name).set({
            players: [],
            state: ROOM_STATES.WAITING_TO_START,
          }).then(doc => {
            log(`created room ${name}`);
            m.redraw();
          });
          return log(`creating room '${name}'...`);
        }
        function listRooms() {
          const rooms = Object.keys(state.rooms)
            .map(room_id => `${room_id} [${state.rooms[room_id].players.length}]`);
          return log(`rooms: ${rooms}`);
        }
        function joinRoom(name) {
          const doc = app.firestore().collection("rooms").doc(name);
          doc.update({
            players: firebase.firestore.FieldValue.arrayUnion(state.uid),
          }).then(() => {
            log(`joined room ${name}`);
            state.current_room = name;
            m.redraw();
          });
          return log(`joining room ${name}...`);
        }
        function startGame() {
          if (!state.current_room) {
            return log("can't start until you've joined a room");
          } 
          const room = state.rooms[state.current_room];
          if (room.state != ROOM_STATES.WAITING_TO_START) {
            return log(`game ${state.current_room} has already started`);
          }
          let deck = generateDeck();
          let hands = {};
          const hand_size = handSize(room.players.length);
          state.room.players.forEach(player => {
            hands[player] = drawTiles(deck, hand_size);
          });
          app.firestore().collection("rooms").doc(state.current_room).update({
            state: `waiting for ${firstPlayer}`
          });
          return log("listRooms unimplemented");
        }
        const commands = {
          help: help,
          make: makeRoom,
          list: listRooms,
          join: joinRoom,
          start: startGame,
        };
        function perform(action) {
          if (!state.uid) {
            console.warn("not logged in");
            return false;
          }
          for (cmd in commands) {
            if (action.startsWith(`/${cmd}`)) {
              const args = action.substring(cmd.length + 1).trim().split(/\s+/);
              return commands[cmd].apply(null, args);
            }
          }
          console.warn(`${action} does not match any of ${Object.keys(commands)}`);
          return false;
        }

        app.auth().signInAnonymously();
        console.log("hello, world!");
        function onUserInput(evt) {
          const v = evt.srcElement.value;
          if (perform(v)) {
            evt.srcElement.value = "";
          } else {
            console.warn("invalid action: ", v);
          }
        }
        m.mount(document.body, state);
      });
    </script>
</html>
